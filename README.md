# Bois & Bocage -- Commercial Prospecting App

Sales prospecting tool for the Bois & Bocage division of Cooperl: hedge diagnostics over 15 years, wood purchasing, carbon credit trading, and farmer compensation. Presents 200 qualified agricultural prospects ranked by a relevance score, with integrated campaign tracking.

## Table of Contents

1. [Tech Stack](#tech-stack)
2. [Architecture](#architecture)
3. [Local Setup](#local-setup)
4. [Database](#database)
5. [Auth Flow](#auth-flow)
6. [Deployment](#deployment)
7. [Component Reference](#component-reference)
8. [User Guide](#user-guide)
9. [Known Limitations](#known-limitations)
10. [Last Audit](#last-audit)

---

## Tech Stack

| Layer | Technology | Version |
|-------|-----------|---------|
| Frontend | React + TypeScript | 18.3.1 / 5.6.3 |
| Bundler | Vite | 6.0.3 |
| Styles | Tailwind CSS | 3.4.15 |
| Icons | lucide-react | 0.460.0 |
| Maps | Leaflet + react-leaflet | 1.9.4 / 4.2.1 |
| Routing | react-router-dom | 6.28.0 |
| BaaS / API | Supabase (PostgREST) | supabase-js 2.49.1 |
| Database | PostgreSQL (via Supabase) | -- |
| Auth | Supabase Auth (prototype) / Keycloak (target DSI) | -- |

State management uses React hooks only (no external state library). No custom backend server.

---

## Architecture

### High-Level Overview

```
Browser (Anne / sales team)
    |
    v
Supabase Auth (email/password -- simulates Keycloak SSO)
    |
    v
React SPA (Vite, Tailwind, Leaflet)
    |
    v
Supabase PostgREST (auto-generated REST API)
    |
    v
PostgreSQL (200 prospects + campaign tracking)
```

The application is a purely static SPA. There is no Express server, no custom backend, no Docker. The frontend communicates directly with PostgreSQL through the PostgREST API auto-generated by Supabase.

### Directory Structure

```
bois-bocage-app/
|-- index.html                  # HTML entry point
|-- package.json
|-- vite.config.ts
|-- tsconfig.json
|-- tailwind.config.js
|-- postcss.config.js
|-- .env.example                # Environment variable template
|-- supabase/
|   `-- schema.sql              # PostgreSQL DDL (tables, indexes, RLS)
`-- src/
    |-- main.tsx                # React bootstrap (StrictMode + BrowserRouter)
    |-- App.tsx                 # Root router + auth guard
    |-- index.css               # Tailwind directives + Leaflet overrides
    |-- types/
    |   `-- index.ts            # TypeScript interfaces + business constants
    |-- lib/
    |   `-- supabase.ts         # Supabase client init (URL + anon key from env)
    |-- hooks/
    |   |-- useAuth.ts          # Auth hook (session, signIn, signOut)
    |   `-- useProspects.ts     # Data hook (fetch prospects + actions, CRUD)
    `-- components/
        |-- Login.tsx           # Login screen (email/password form)
        |-- Layout.tsx          # Header bar + tab navigation
        |-- Dashboard.tsx       # Pipeline view: KPIs + table + filters + CSV export
        |-- MapView.tsx         # Leaflet map with colored markers
        |-- ProspectCard.tsx    # Prospect detail card + actions + score breakdown
        |-- CampaignTracker.tsx # Campaign tracking: goal gauge + pipeline + history
        `-- Limitations.tsx     # Feature limitations page (server-side features roadmap)
```

14 source files total (8 components, 2 custom hooks, 1 lib, 1 types, 1 CSS, 1 entry point).

### Data Flow

```
CSV from Dataiku (bb_prospects_top200.csv)
    |
    v  (manual import into Supabase Table Editor)
PostgreSQL table "prospects" (200 rows)
    |
    v  (PostgREST auto-generated API)
useProspects hook (parallel fetch: prospects + actions)
    |
    v  (enrichment: derive status from latest action)
ProspectWithStatus[] passed via props to all views
```

### Routes

| Route | Component | Description |
|-------|-----------|-------------|
| `/` | `Dashboard` | Prospect pipeline (default) |
| `/carte` | `MapView` | Map view |
| `/prospect/:id` | `ProspectCard` | Prospect detail |
| `/suivi` | `CampaignTracker` | Campaign tracking |
| `/limitations` | `Limitations` | Feature limitations and roadmap |
| `*` | Redirect to `/` | Fallback |

---

## Local Setup

### Prerequisites

- **Node.js** 18+
- **npm** (included with Node.js)
- A **Supabase** account ([supabase.com](https://supabase.com))

### 1. Configure Supabase

1. Create a project on [supabase.com](https://supabase.com).
2. In **SQL Editor**, paste and run the contents of `supabase/schema.sql`.
3. Create a user in **Authentication > Users > Add user** (e.g. `demo@bois-bocage.fr`).
4. In **Table Editor > prospects > Import data**, import the CSV file `bb_prospects_top200.csv` (generated from Dataiku).
5. Copy the project URL and `anon` key from **Settings > API**.

### 2. Configure the App

```bash
cp .env.example .env
```

Edit `.env`:

```
VITE_SUPABASE_URL=
VITE_SUPABASE_ANON_KEY=
```

### 3. Install and Run

```bash
npm install
npm run dev
```

The app is available at `http://localhost:5173`.

### 4. Production Build

```bash
npm run build
```

Output is in the `dist/` folder -- a pure static site (HTML + JS + CSS) deployable on any static hosting.

### npm Scripts

| Command | Description |
|---------|-------------|
| `npm run dev` | Vite dev server with hot reload (port 5173) |
| `npm run build` | TypeScript check + Vite production build (`dist/`) |
| `npm run preview` | Preview the production build locally |

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `VITE_SUPABASE_URL` | Yes | Supabase project URL |
| `VITE_SUPABASE_ANON_KEY` | Yes | Supabase public anonymous key |

Both variables are prefixed with `VITE_` so they are exposed to the frontend by Vite. They are injected at build time and visible in the client bundle. This is expected: the `anon` key is public and RLS policies protect the data.

---

## Database

### Schema

Defined in `supabase/schema.sql`. Two tables with a foreign key relationship:

```
prospects (1) ---< actions (N)
     id  <----  prospect_id (FK, ON DELETE CASCADE)
```

#### `prospects` -- 200 Qualified Agricultural Prospects

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `BIGINT` | PK, auto-increment | Technical ID |
| `numero_tiers` | `TEXT` | UNIQUE, NOT NULL | Business ID (AS400) |
| `civilite` | `TEXT` | nullable | Title (M. / Mme / GAEC / EARL) |
| `nom` | `TEXT` | NOT NULL | Farm name |
| `rue` | `TEXT` | nullable | Street address |
| `code_postal` | `TEXT` | nullable | Postal code |
| `ville` | `TEXT` | nullable | City |
| `departement` | `TEXT` | nullable | Department number |
| `zone_geographique` | `TEXT` | nullable | Commercial zone (A-Z) |
| `telephone_domicile` | `TEXT` | nullable | Home phone |
| `telephone_elevage` | `TEXT` | nullable | Farm phone |
| `adresse_email` | `TEXT` | nullable | Email address |
| `sau_estimee_ha` | `NUMERIC` | nullable | Estimated agricultural area (hectares) |
| `source_sau` | `TEXT` | nullable | Estimation method: "contrats" or "tonnages" |
| `sau_contrats_ha` | `NUMERIC` | nullable | Area from contract declarations |
| `sau_tonnages_ha` | `NUMERIC` | nullable | Area computed from tonnage/yield |
| `tonnage_total` | `NUMERIC` | nullable | Total cereal tonnage delivered |
| `certifications` | `TEXT` | nullable | Certification codes (HVE, Bio, CEC) |
| `latitude` | `NUMERIC` | nullable | GPS latitude |
| `longitude` | `NUMERIC` | nullable | GPS longitude |
| `annee_fidelite` | `NUMERIC` | nullable | Cooperation seniority (years) |
| `score_pertinence` | `INTEGER` | -- | Relevance score 0-100 |
| `tc_referent` | `TEXT` | nullable | Assigned sales representative |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | Record creation timestamp |

#### `actions` -- Campaign Tracking

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `BIGINT` | PK, auto-increment | Technical ID |
| `prospect_id` | `BIGINT` | FK -> prospects(id), CASCADE, NOT NULL | Associated prospect |
| `type` | `TEXT` | NOT NULL, CHECK IN ('appele','interesse','refus','rappeler','recrute') | Action type |
| `notes` | `TEXT` | nullable | Free-text notes |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | Action timestamp |
| `created_by` | `TEXT` | nullable | Email of the user who created the action |

### Indexes

| Name | Table | Columns | Purpose |
|------|-------|---------|---------|
| `idx_prospects_score` | prospects | `score_pertinence DESC` | Default Dashboard sort |
| `idx_prospects_dept` | prospects | `departement` | Department filter |
| `idx_prospects_zone` | prospects | `zone_geographique` | Zone filter |
| `idx_actions_prospect` | actions | `prospect_id` | Prospect -> actions join |
| `idx_actions_type` | actions | `type` | Action type filtering |

### RLS Policies (Row Level Security)

Both tables have RLS enabled. Anonymous access is explicitly revoked (`REVOKE ALL ON ... FROM anon`). Current policies as defined in `schema.sql`:

| Policy | Table | Operation | Role | Condition |
|--------|-------|-----------|------|-----------|
| `prospects_select_auth` | prospects | SELECT | authenticated | `true` |
| `actions_select_auth` | actions | SELECT | authenticated | `true` |
| `actions_insert_auth` | actions | INSERT | authenticated | `created_by = auth.jwt()->>'email'` |

No policies exist for `UPDATE` or `DELETE` on either table -- those operations are denied by default when RLS is enabled. The `prospects` table is read-only from the application perspective (data is imported via Supabase Table Editor or direct SQL).

### Scoring Formula

The score is pre-computed in Dataiku and imported with the CSV. The decomposition:

| Criterion | Points | Condition |
|-----------|--------|-----------|
| SAU > 0 ha | +30 | Primary filter |
| SAU > 50 ha | +20 | Large farm |
| Certified HVE/Bio | +15 | Environmental certification |
| Tonnage > 100 t | +10 | Active cereal collector |
| Loyalty >= 3 years | +10 | Long-term engagement |

Maximum decomposed score is 85 points. Actual score may be higher due to additional Dataiku-side criteria.

### Migrations

There is no migration framework. Schema changes are applied by running SQL directly in the Supabase SQL Editor. The canonical schema is `supabase/schema.sql`.

---

## Auth Flow

1. User opens the app.
2. `useAuth` checks for an existing Supabase session via `getSession()` and subscribes to `onAuthStateChange`.
3. If not authenticated: the `Login` component is rendered.
4. User enters email + password.
5. `signInWithPassword` sends credentials to Supabase Auth.
6. Supabase returns a JWT stored in `localStorage` by `@supabase/supabase-js`.
7. All PostgREST requests include this JWT in the `Authorization` header.
8. RLS policies grant access based on the `authenticated` role.

There is no sign-up form. Users must be created manually in the Supabase dashboard (Authentication > Users > Add user). No OAuth or magic link flow is implemented.

In the target DSI environment, Keycloak will replace Supabase Auth. The JWT will be issued by Keycloak, and RLS policies will be tightened with role-based filtering (TC, manager, admin).

---

## Deployment

### Current -- GitHub Pages via `gh-pages`

The project includes `gh-pages` (v6.3.0) as a dev dependency for static deployment to GitHub Pages.

```bash
npm run build
```

The `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY` environment variables must be set at build time (they are inlined into the JS bundle). Output is in the `dist/` folder -- a pure static site (HTML + JS + CSS) deployable on any static hosting (GitHub Pages, Netlify, Vercel, Nginx, S3+CloudFront).

### Target -- DSI Environment (February 21, 2026)

The DSI prototyping environment will provide:

| Component | Availability | Role |
|-----------|-------------|------|
| **Keycloak** | V1 (Feb 21) | Enterprise SSO (Google Cooperl). Role management (TC, manager, admin). |
| **PostgreSQL** | V1 (Feb 21) | Database. RLS for per-user data filtering. |
| **Git** | V1 (Feb 21) | Code repository. Potentially automatic deployment via git push. |
| **Token Exchange** | V2 (March) | External API gatekeeper (Claude, Dataiku). Per-app limited tokens. |
| **API Gateway** | V2 (March) | Single entry point. Auth, quotas, logging. |

**Not available in DSI**: Docker, local LLM (Ollama), n8n, MCP Dataiku.

### Supabase to DSI Migration

The SQL schema (`supabase/schema.sql`) is standard PostgreSQL. Migration changes are limited to environment variables:

| Variable | Supabase (proto) | DSI (target) |
|----------|-------------------|-------------|
| `VITE_SUPABASE_URL` | `https://xxx.supabase.co` | DSI PostgREST URL |
| `VITE_SUPABASE_ANON_KEY` | Supabase anon key | Keycloak JWT |

The `@supabase/supabase-js` client is compatible with any standard PostgREST endpoint. If DSI does not provide PostgREST, alternatives include replacing `supabase-js` with direct `fetch` calls or deploying PostgREST standalone.

For RLS migration: remove any `anon` policies, keep and tighten `authenticated` policies, add Keycloak role-based filtering where needed.

---

## Component Reference

### `App.tsx` -- Root Router and Auth Guard

Uses `useAuth` to determine authentication state. Renders `Login` if unauthenticated, otherwise renders `AuthenticatedApp` containing `Layout` and `Routes`. `useProspects` is instantiated once inside `AuthenticatedApp` and data is passed to child components via props.

### `Login.tsx` -- Login Screen

Email/password form with HTML validation. Displays "Email ou mot de passe incorrect" on error. Shows TreePine logo and "Bois & Bocage -- Prospection commerciale" branding.

### `Layout.tsx` -- Page Structure and Navigation

Green header bar (`bg-cooperl-700`) with logo, title, user email, and sign-out button. Tab navigation with 4 links: Pipeline (`/`), Carte (`/carte`), Suivi (`/suivi`), Limitations (`/limitations`). Active tab is underlined in green.

### `Dashboard.tsx` -- Prospect Pipeline

- **KPIs** (4 cards): prospect count, total SAU, certification %, average score.
- **Filters**: text search, department dropdown, zone dropdown, certification checkbox, minimum score.
- **Table**: sortable columns (name, dept, zone, SAU, score), color-coded score/status badges, row click navigates to prospect detail.
- **CSV Export**: exports currently filtered prospects.

### `MapView.tsx` -- Map View

Leaflet map centered on Brittany (lat 48.1, lng -2.8, zoom 7). OpenStreetMap tiles. Color-coded circle markers (green >= 70, orange 50-69, red < 50). Click popup with prospect summary and link to detail card.

### `ProspectCard.tsx` -- Prospect Detail

Header with name, numero_tiers, zone, status badge. Contact info with clickable `tel:` and `mailto:` links. Farm data (SAU, tonnage, certifications, loyalty). Score decomposition (5 criteria with points). 5 action buttons (appele, interesse, rappeler, refus, recrute). Chronological action history.

### `CampaignTracker.tsx` -- Campaign Tracking

- **Goal Gauge**: progress bar toward 40 annual recruitments.
- **Pipeline by Status**: 6 cards (recrute, interesse, appele, rappeler, refus, en_attente) with counts and stacked progress bar.
- **Recent Actions**: last 20 actions across all prospects, clickable to navigate to prospect.

### `Limitations.tsx` -- Feature Limitations

Lists 7 features that require server-side infrastructure and are not available in the current static SPA deployment: automated reminders, PDF export, bulk data import, inter-user notifications, role-based access, SI synchronization, and advanced reporting.

### Hooks

| Hook | Returns | Description |
|------|---------|-------------|
| `useAuth` | `{ user, loading, signIn, signOut }` | Session management via `getSession()` + `onAuthStateChange` |
| `useProspects` | `{ prospects, actions, loading, refetch, addAction }` | Parallel fetch of prospects (sorted by score DESC) and actions (sorted by date DESC), enrichment with derived status |

### Types (`src/types/index.ts`)

| Export | Kind | Description |
|--------|------|-------------|
| `Prospect` | interface | 22 fields matching `prospects` table columns |
| `ActionType` | type union | `'appele' \| 'interesse' \| 'refus' \| 'rappeler' \| 'recrute'` |
| `Action` | interface | 6 fields matching `actions` table columns |
| `ProspectWithStatus` | interface | Extends `Prospect` with `statut` and `derniere_action` |
| `ACTION_LABELS` | Record | French labels for each status (including `en_attente`) |
| `ACTION_COLORS` | Record | Tailwind CSS classes for each status badge |
| `ScoreCriterion` | interface | Decomposed scoring criterion (label, points, max, met) |
| `decomposeScore` | function | Decomposes a prospect's score into 5 criteria |

---

## User Guide

### Login

1. Open the app in a browser.
2. Enter the email and password provided by the administrator.
3. Click **Se connecter**.
4. The account must have been created in Supabase Auth (or Keycloak in target DSI).

### Pipeline Screen (Home)

Default view showing 200 prospects sorted by relevance score.

- **KPIs**: prospect count, total SAU, certification %, average score. Update automatically with active filters.
- **Filters**: text search (name or numero_tiers), department, zone, certification checkbox, minimum score.
- **Sort**: click column headers (Exploitation, Dept, Zone, SAU, Score). First click descending, second click reverses.
- **CSV Export**: click the green **CSV** button to download filtered prospects as `prospects_bois_bocage.csv`.
- **Open Detail**: click any row to navigate to the prospect's detail card.

### Map Screen

Displays geolocated prospects as colored markers on a Leaflet map. Green (score >= 70), orange (50-69), red (< 50). Click a marker for a popup with summary and "Voir la fiche" link.

### Prospect Detail Screen

Accessible by clicking a prospect from Pipeline or Map. Shows contact info (clickable phone/email), farm data, score decomposition, action buttons, and action history.

**Recording an action**: click one of the 5 action buttons (Appele, Interesse, Rappeler, Refus, Recrute). The action is saved immediately with timestamp. Status updates across the app.

### Campaign Tracking Screen

Progress gauge toward 40 annual recruitments. Pipeline breakdown by status (6 cards + stacked bar). List of the 20 most recent actions with prospect names and clickable navigation.

---

## Known Limitations

| Limitation | Detail |
|-----------|--------|
| Static data | CSV snapshot import, no live Dataiku connection. Refresh by re-import. |
| Pre-computed scoring | Score is calculated in Dataiku, no real-time recalculation in the app. |
| No workflow automation | Actions are local. No notifications, no automatic triggers. |
| Single service | Bois & Bocage only. No integration with RSE, GTE-v, or Collecte. |
| Prototype auth | Supabase Auth simulates Keycloak SSO. No granular roles. |
| No table pagination | All 200 prospects are loaded at once. No server-side pagination. |
| No test suite | 0 test files. No unit, integration, or e2e tests. |

---

## Last Audit

**Date**: 2026-02-11
**Score**: ~20/100 (Grade D)
**Status**: CRIT + HIGH fixes in progress

### Summary of Findings

| Severity | Count | Key Findings |
|----------|-------|--------------|
| CRITICAL | 2 | RLS INSERT policy on `actions` bypassable when `userEmail` is undefined; no UPDATE/DELETE policies on `actions` table |
| HIGH | 8 | No `AbortController` on fetches, full refetch on each insert, auth race condition on `getSession`, no pagination, silent error on actions fetch, unconditional data fetch before auth resolves, PostgREST schema exposure via error responses, no error feedback to user |
| MEDIUM | 17 | `SELECT *` fetches all PII columns, `USING(true)` on prospects allows any authenticated user full read, props drilling through component tree, no map marker clustering, non-null assertions on route params, `confirm()` blocks UI thread, among others |
| LOW | 14 | JWT stored in `localStorage`, no HTTP security headers (CSP, HSTS), hardcoded base path, no list virtualization, minor accessibility gaps |

**Total**: 41 findings (38 unique after deduplication).
